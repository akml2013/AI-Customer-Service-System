<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>AI客服问答系统</title>
<!--    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>-->
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .session-sidebar {
            width: 250px;
            background-color: #34495e;
            color: white;
            padding: 20px 15px;
            overflow-y: auto;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background-color: #f9f9f9;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #fafafa;
        }

        .message {
            max-width: 80%;
            margin-bottom: 20px;
            clear: both;
        }

        .user-message {
            background-color: #3498db;
            color: white;
            border-radius: 18px 18px 0 18px;
            float: right;
        }

        .bot-message {
            background-color: #ecf0f1;
            color: #333;
            border-radius: 18px 18px 18px 0;
            float: left;
        }

        .message-content {
            padding: 12px 16px;
        }

        .input-area {
            padding: 20px;
            border-top: 1px solid #eee;
            background-color: white;
            display: flex;
            gap: 10px;
        }

        #question-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 24px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        #question-input:focus {
            border-color: #3498db;
        }

        #send-btn {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 24px;
            padding: 12px 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        #send-btn:hover {
            background-color: #2980b9;
        }

        #send-btn.disabled {
            background-color: #cccccc !important;
            cursor: not-allowed !important;
            opacity: 0.7 !important;
        }

        .session-item {
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            cursor: pointer;
            background-color: rgba(255,255,255,0.1);
            transition: background-color 0.3s;
        }

        .session-item:hover {
            background-color: rgba(255,255,255,0.2);
        }

        .session-item.active {
            background-color: #3498db;
            font-weight: 600;
        }

        .session-title {
            font-size: 18px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .new-session-btn {
            background-color: #3498db;
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            width: 100%;
            margin-top: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .new-session-btn:hover {
            background-color: #2980b9;
        }

        /* 按钮间隔调整 */
        .new-session-btn {
            margin-bottom: 15px; /* 增加底部间距 */
        }

        /* 会话列表顶部间距 */
        .session-list {
            margin-top: 10px;
        }
    </style>

    <style>
        /* 会话项新样式 */
        .session-item {
            position: relative;
            padding: 15px 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .session-item:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }

        .session-item.active {
            background-color: #3498db;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .session-title-text {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .session-time {
            font-size: 12px;
            opacity: 0.8;
        }

        .session-placeholder {
            padding: 15px;
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
        }

        .empty-message {
            text-align: center;
            font-size: 14px;
            padding: 10px;
            color: rgba(255, 255, 255, 0.7);
        }

        .error-message {
            background-color: #e74c3c;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px;
            font-size: 14px;
        }
        /* 更新后的导航按钮样式 */
        .nav-buttons {
            display: flex;
            gap: 8px;
        }

        .nav-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 15px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            white-space: nowrap;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .header-right {
            display: flex;
            align-items: center;
        }

        .header-content {
            display: flex;
            align-items: center;
            width: 100%;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .title-container {
            display: flex;
            align-items: center;
        }

        .title-container h1 {
            margin-right: 15px;
        }
    </style>
</head>
<body>
<!-- 标题栏 -->
<div class="header">
<!--    <h1>AI客服问答系统</h1>-->
<!--    <div class="nav-buttons">-->
<!--        <button class="nav-button" onclick="navigateToKnowledge()">知识库</button>-->
<!--        <button class="nav-button" onclick="navigateToHistory()">问答历史</button>-->
<!--    </div>-->
<!--    <div>-->
<!--        <span>您好，<span th:text="${userName}">用户</span></span>-->
<!--        <a href="/auth/logout" style="color: white; margin-left: 15px;" onclick="handleLogout()">登出</a>-->
<!--    </div>-->

    <div class="header-content">
        <div class="header-left">
            <div class="title-container">
                <h1>AI客服问答系统</h1>
                <div class="nav-buttons">
                    <button class="nav-button" onclick="navigateToKnowledge()">知识库</button>
                    <button class="nav-button" onclick="navigateToHistory()">问答历史</button>
                </div>
            </div>
        </div>

        <div class="header-right">
            <span>您好，<span th:text="${userName}">用户</span></span>
            <a href="/auth/logout" style="color: white; margin-left: 15px;" onclick="handleLogout()">登出</a>
        </div>
    </div>
</div>

<div class="main-container">
    <!-- 左侧会话列表 -->
    <div class="session-sidebar">
        <div class="session-title">会话列表</div>
        <div>
            <button class="new-session-btn" onclick="createNewSession()">新建会话</button>
        </div>
        <div class="session-list" id="session-list">
<!--            &lt;!&ndash; 静态示例会话项 &ndash;&gt;-->
<!--            <div class="session-item active">产品咨询</div>-->
<!--            <div class="session-item">技术问题</div>-->
<!--            <div class="session-item">售后服务</div>-->
            <!-- 动态会话列表 -->
<!--            <div th:each="session : ${sessions}"-->
<!--                 class="session-item"-->
<!--                 th:class="${session.id == activeSessionId} ? 'active' : ''"-->
<!--                 th:text="${session.title}"-->
<!--                 th:data-id="${session.id}"-->
<!--                 th:onclick="loadSession(this.dataset.id)">-->
<!--            </div>-->
            <div class="session-placeholder">加载会话列表中...</div>
        </div>
    </div>

    <!-- 右侧对话区域 -->
    <div class="chat-container">
        <div class="chat-header">
            <h2 id="session-title">新会话</h2>
        </div>

        <!-- 对话历史 -->
        <div class="chat-history" id="chat-history">
<!--            &lt;!&ndash; 初始欢迎消息 &ndash;&gt;-->
<!--            <div class="message bot-message">-->
<!--                <div class="message-content">-->
<!--                    您好！我是AI客服助手，请问有什么可以帮您？-->
<!--                </div>-->
<!--            </div>-->
        </div>

        <!-- 输入区域 -->
        <div class="input-area">
            <input type="hidden" id="userId" th:value="${userId}">
            <input type="hidden" id="userName" th:value="${userName}">
            <input type="hidden" id="AUTH_TOKEN" th:value="${AUTH_TOKEN}">
            <input type="text"
                   id="question-input"
                   placeholder="请输入您的问题..."
                   autocomplete="off">
            <button id="send-btn">发送</button>
        </div>
    </div>
</div>

<script>
    // 新增导航函数
    function navigateToKnowledge() {
        const userId = document.getElementById('userId').value;
        const userName = document.getElementById('userName').value;
        const authToken = document.getElementById('AUTH_TOKEN').value;
        window.location.href = `/view/knowledge?userId=${userId}&userName=${userName}&token=${authToken}`;
    }

    function navigateToHistory() {
        const userId = document.getElementById('userId').value;
        const userName = document.getElementById('userName').value;
        const authToken = document.getElementById('AUTH_TOKEN').value;
        window.location.href = `/view/history?userId=${userId}&userName=${userName}&token=${authToken}`;
    }
</script>

<script>
    // 全局状态管理
    const state = {
        currentSessionId: null,    // 当前会话ID
        userId: null,              // 当前用户ID
        sseConnection: null,       // SSE连接实例
        currentBotMessage: null,   // 当前正在构建的AI消息
        systemMessages: [],        // 系统消息元素引用
        clientId: null,            // 当前会话专属clientId
        timeoutId: null            // 用于存储超时定时器的ID
    };

    // 获取Cookie的函数
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    // 页面初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 获取用户信息
        state.userId = document.getElementById('userId').value;
        console.log(`[初始化] 用户ID: ${state.userId}`);

        // state.authToken = getCookie('AUTH_TOKEN');
        state.authToken = document.getElementById('AUTH_TOKEN').value;
        console.log(`[初始化] 用户TOKEN: ${state.authToken}`);

        state.clientId = `client_${state.userId}_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;
        console.log(`[初始化] 生成clientId: ${state.clientId}`);

        // 获取当前会话ID（如果有）
        const urlParams = new URLSearchParams(window.location.search);
        state.currentSessionId = urlParams.get('sessionId');
        console.log(`[初始化] 当前会话ID: ${state.currentSessionId}`);

        // 设置事件监听
        setupEventListeners();

        // 建立SSE连接
        connectToSSE();

        // 获取会话列表
        fetchSessions();

        // 检查是否有选中的会话
        if (state.currentSessionId) {
            loadSession(state.currentSessionId);
        }
    });

    // 设置事件监听
    function setupEventListeners() {
        // 发送按钮事件
        const sendBtn = document.getElementById('send-btn');
        sendBtn.addEventListener('click', sendQuestion);

        // 支持回车键发送
        const questionInput = document.getElementById('question-input');
        questionInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendQuestion();
            }
        });

        // 登出事件
        const logoutLink = document.querySelector('a[href="/auth/logout"]');
        logoutLink.addEventListener('click', function(e) {
            e.preventDefault(); // 阻止默认行为
            handleLogout();
        });
    }

    // 处理登出
    function handleLogout() {
        console.log("[登出] 关闭SSE连接并清理");
        if (state.sseConnection) {
            state.sseConnection.close();
        }

        window.location.href = `/auth/logout?clientId=${state.clientId}`;
    }

    // 新增函数：获取会话列表
    function fetchSessions() {
        fetch('/history/sessions', {
            method: 'GET',
            headers: {
                'X-User-Id': state.userId,
                'X-Auth-Token': state.authToken
            }
        })
            .then(response => {
                if (response.status === 401) {
                    // 未授权处理
                    window.location.href = '/auto/logout';
                    return;
                }
                if (!response.ok) {
                    throw new Error('获取会话列表失败');
                }
                return response.json();
            })
            .then(sessions => {
                renderSessions(sessions);
            })
            .catch(error => {
                console.error('获取会话列表错误:', error);
                // 显示错误消息
                document.getElementById('session-list').innerHTML =
                    `<div class="session-item error">加载失败，请刷新页面</div>`;
            });
    }

    // 新增函数：渲染会话列表
    function renderSessions(sessions) {
        const sessionList = document.getElementById('session-list');
        sessionList.innerHTML = '';

        if (sessions.length === 0) {
            sessionList.innerHTML = `
                <div class="session-item">
                    <div class="empty-message">暂无历史会话</div>
                </div>
            `;
            return;
        }

        // 使用第一个会话初始化当前会话
        if (!state.currentSessionId) {
            state.currentSessionId = sessions[0].id;
        }

        sessions.forEach(session => {
            const sessionItem = document.createElement('div');
            sessionItem.className = 'session-item';
            if (session.id === state.currentSessionId) {
                sessionItem.classList.add('active');
            }
            sessionItem.dataset.id = session.id;

            // 添加会话标题
            const titleSpan = document.createElement('span');
            titleSpan.className = 'session-title-text';

            if(session.title===''){
                titleSpan.textContent = "新会话";
            }
            else{
                titleSpan.textContent = session.title;
            }

            sessionItem.appendChild(titleSpan);
            sessionItem.addEventListener('click', () => loadSession(session.id));

            sessionList.appendChild(sessionItem);
        });

        // 自动加载第一个会话
        if (sessions.length > 0 && state.currentSessionId) {
            loadSession(sessions[0].id);
            document.getElementById('session-title').textContent = sessions[0].title;
        }
    }

    function loadSession(sessionId) {
        console.log(`[会话] 加载会话: ${sessionId}`);
        // 更新当前会话ID
        state.currentSessionId = sessionId;

        // 更新URL
        const url = new URL(window.location);
        url.searchParams.set('sessionId', sessionId);
        window.history.pushState({}, '', url);

        // 激活选中的会话项
        document.querySelectorAll('.session-item').forEach(item => {
            item.classList.toggle('active', item.dataset.id === sessionId);
        });

        // 先清除聊天历史
        clearChatHistory();

        // 显示加载中的提示
        addMessage('加载会话中...', 'system');

        // 获取该会话的对话历史
        fetch(`/history/qa_pairs?sessionId=${sessionId}`, {
            method: 'GET',
            headers: {
                'X-User-Id': state.userId,
                'X-Auth-Token': state.authToken
            }
        })
            .then(response => {
                if (response.status === 401) {
                    // 未授权处理
                    window.location.href = '/auth/logout';
                    return;
                }
                if (!response.ok) {
                    throw new Error('获取会话记录失败');
                }
                return response.json();
            })
            .then(qaPairs => {
                // 清空加载提示
                document.getElementById('chat-history').innerHTML = '';

                if (qaPairs.length === 0) {
                    document.getElementById('session-title').textContent = '新会话';
                    return;
                }

                // 渲染对话历史
                renderConversation(qaPairs);

                // 设置会话标题
                const sessionItem = document.querySelector(`.session-item[data-id="${sessionId}"]`);
                if (sessionItem) {
                    document.getElementById('session-title').textContent = sessionItem.querySelector('.session-title-text').textContent;
                }
            })
            .catch(error => {
                console.error('加载会话记录错误:', error);
                addMessage('加载会话失败，请稍后重试', 'system');
            });
    }

    // 新增函数：渲染对话历史
    function renderConversation(qaPairs) {
        qaPairs.forEach(pair => {
            // 添加用户提问
            if (pair.question) {
                addMessage(pair.question, 'user');
            }

            // 添加AI回答
            if (pair.answer) {
                addMessage(pair.answer, 'bot');
            }
        });

        // 滚动到底部
        scrollToBottom();
    }

    // 新增函数：清除聊天历史
    function clearChatHistory() {
        const chatHistory = document.getElementById('chat-history');
        chatHistory.innerHTML = '';
    }

    // 创建会话DOM元素
    function createSessionElement(sessionId) {
        console.log(`[会话] 创建新的会话元素: ${sessionId}`);

        const sessionList = document.querySelector('.session-list');
        const sessionItem = document.createElement('div');
        sessionItem.className = 'session-item';
        sessionItem.dataset.id = sessionId;
        sessionItem.textContent = `新会话 ${new Date().toLocaleTimeString()}`;
        sessionItem.addEventListener('click', () => loadSession(sessionId));

        sessionList.appendChild(sessionItem);

        // 激活新会话项
        document.querySelectorAll('.session-item').forEach(item => {
            item.classList.remove('active');
        });
        sessionItem.classList.add('active');

        return sessionItem;
    }

    // 创建新会话
    function createNewSession() {
        console.log('[会话] 向后端请求创建新会话');

        clearNoSessionPlaceholder(); // 新建会话时清除

        // 显示加载提示
        const sessionList = document.getElementById('session-list');
        const loadingIndicator = document.createElement('div');
        loadingIndicator.className = 'session-loading';
        loadingIndicator.textContent = '创建新会话中...';
        sessionList.insertBefore(loadingIndicator, sessionList.firstChild);

        fetch('/history/create', {
            method: 'POST',
            headers: {
                'X-User-Id': state.userId,
                'X-Auth-Token': state.authToken
            }
        })
            .then(response => {
                // 移除加载提示
                loadingIndicator.remove();

                if (response.status === 401) {
                    window.location.href = '/auth/logout';
                    return Promise.reject('Unauthorized');
                }
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || '创建新会话失败');
                    });
                }
                return response.text(); // 直接获取响应文本作为sessionId
            })
            .then(sessionId => {
                console.log('[创建会话] 新会话ID:', sessionId);
                state.currentSessionId = sessionId;

                // 更新URL
                const url = new URL(window.location);
                url.searchParams.set('sessionId', sessionId);
                window.history.pushState({}, '', url);

                // 创建会话列表项并添加到顶部
                const sessionList = document.getElementById('session-list');
                const newSessionItem = document.createElement('div');
                newSessionItem.className = 'session-item active';
                newSessionItem.dataset.id = sessionId;
                newSessionItem.innerHTML = '<span class="session-title-text">新会话</span>';
                newSessionItem.addEventListener('click', () => loadSession(sessionId));

                // 添加到列表顶部
                sessionList.insertBefore(newSessionItem, sessionList.firstChild);

                // 移除其他会话项的active状态
                document.querySelectorAll('.session-item').forEach(item => {
                    if (item.dataset.id !== sessionId) {
                        item.classList.remove('active');
                    }
                });

                // 设置会话标题
                document.getElementById('session-title').textContent = '新会话';

                // 清空聊天历史
                document.getElementById('chat-history').innerHTML = '';
            })
            .catch(error => {
                console.error('创建会话失败:', error);

                // 显示错误消息
                const sessionList = document.getElementById('session-list');
                const errorMessage = document.createElement('div');
                errorMessage.className = 'session-error';
                errorMessage.textContent = '创建会话失败';
                sessionList.appendChild(errorMessage);

                newSessionItem.addEventListener('click', () => loadSession(sessionId));

                // 3秒后移除错误消息
                setTimeout(() => {
                    if (errorMessage.parentNode) {
                        errorMessage.remove();
                    }
                }, 3000);
            });
    }

    // 在本地创建临时会话
    function createTempSessionInList(sessionId) {
        state.currentSessionId = sessionId;

        // 创建临时会话项
        const sessionItem = document.createElement('div');
        sessionItem.className = 'session-item active';
        sessionItem.dataset.id = sessionId;
        sessionItem.innerHTML = '<span class="session-title-text">新会话</span>';
        sessionItem.addEventListener('click', () => loadSession(sessionId));

        // 添加到会话列表开头
        const sessionList = document.getElementById('session-list');
        sessionList.insertBefore(sessionItem, sessionList.firstChild);

        // 更新状态
        document.getElementById('session-title').textContent = '新会话';

        return sessionItem;
    }

    // 建立SSE连接
    function connectToSSE() {
        // 生成唯一的clientID（用户ID+会话ID）
        const clientId = state.clientId;

        console.log(`[SSE] 建立连接 clientId=${clientId}`);

        // 关闭现有连接
        if (state.sseConnection) {
            state.sseConnection.close();
        }

        // 创建新的SSE连接
        state.sseConnection = new EventSource(`/sse/connect?clientId=${clientId}`);

        // 连接打开事件
        state.sseConnection.onopen = () => {
            console.log("[SSE] 连接已建立");
        };

        // 处理answer-chunk事件
        state.sseConnection.addEventListener('answer-chunk', (event) => {
            console.log("[SSE] 收到消息:", event.data);

            // 刷新超时定时器
            refreshTimeoutTimer();

            processChunk(event.data);
        });

        // 处理answer-complete事件
        state.sseConnection.addEventListener('answer-complete', () => {
            console.log("[SSE] 收到完成通知");

            // 清除超时定时器
            clearTimeout(state.timeoutId);
            state.timeoutId = null;

            // 重新启用发送按钮
            enableSendButton();

            removeSystemMessages();
            state.currentBotMessage = null;
        });

        // 错误处理
        state.sseConnection.onerror = (error) => {
            console.error("[SSE] 连接错误:", error);

            // 确保发送按钮被启用
            enableSendButton();

            setTimeout(connectToSSE, 3000);
        };
    }

    // 刷新超时定时器
    function refreshTimeoutTimer() {
        // 清除现有定时器
        if (state.timeoutId) {
            clearTimeout(state.timeoutId);
        }

        // 设置新的5秒超时定时器
        state.timeoutId = setTimeout(() => {
            console.warn("[Timeout] 5秒未收到新消息，恢复发送功能");

            // 清除超时ID
            state.timeoutId = null;

            // 启用发送按钮
            enableSendButton();
        }, 5000);
    }

    // 禁用发送按钮
    function disableSendButton() {
        const sendBtn = document.getElementById('send-btn');
        if (sendBtn) {
            sendBtn.disabled = true;
            sendBtn.classList.add('disabled');
        }
    }

    // 启用发送按钮
    function enableSendButton() {
        const sendBtn = document.getElementById('send-btn');
        if (sendBtn) {
            sendBtn.disabled = false;
            sendBtn.classList.remove('disabled');
        }
    }

    // 发送问题
    function sendQuestion() {
        const input = document.getElementById('question-input');
        const question = input.value.trim();

        if (!question) return;

        // 禁用发送按钮
        disableSendButton();

        // 设置5秒超时定时器
        refreshTimeoutTimer();

        console.log(`[发送] 问题: ${question}, 会话ID: ${state.currentSessionId}`);

        // 添加到聊天历史
        addMessage(question, 'user');
        input.value = '';

        // 显示"正在处理中"的提示
        const systemMessage = addSystemMessage("正在处理中...");

        if (!state.sseConnection || state.sseConnection.readyState === EventSource.CLOSED) {
            console.log('[SSE] 连接已关闭，尝试重新连接');
            connectToSSE();
        }

        // 发送问题到后端
        fetch('/qa/ask', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                userId: state.userId,
                sessionId: state.currentSessionId,
                question: question,
                clientId: state.clientId
            })
        })
            .then(response => {
                console.log("[响应] 状态码:", response.status);
                return response.json();
            })
            .then(data => {
                console.log("[响应] 数据:", data);

                const currentSessionTitle = document.getElementById('session-title').textContent;
                if (currentSessionTitle === '新会话' || currentSessionTitle === '') {
                    console.log(`[会话] 更新会话ID: ${data.sessionId}`);
                    state.currentSessionId = data.sessionId;

                    // 调用接口获取会话详情
                    fetch(`/history/session?sessionId=${data.sessionId}`, {
                        headers: {
                            'X-User-Id': state.userId,
                            'X-Auth-Token': state.authToken
                        }
                    })
                        .then(res => res.json())
                        .then(sessionInfo => {
                            // 本地创建临时会话
                            const sessionList = document.getElementById('session-list');
                            const emptyMessage = sessionList.querySelector('.empty-message');

                            if (emptyMessage) {
                                clearNoSessionPlaceholder();
                                createTempSessionInList(data.sessionId);
                            }

                            if(sessionInfo.title !== null && sessionInfo.title !== ''){
                                // 更新会话标题
                                const sessionItem = document.querySelector(`.session-item[data-id="${data.sessionId}"]`);
                                if (sessionItem) {
                                    const titleSpan = sessionItem.querySelector('.session-title-text');
                                    titleSpan.textContent = sessionInfo.title;
                                }

                                console.log(`[会话] 更新标题: ${sessionInfo.title}`);
                                document.getElementById('session-title').textContent = sessionInfo.title;
                            }
                            // // 加载新会话
                            // loadSession(data.sessionId);
                        })
                        .catch(err => {
                            console.error('获取会话详情失败:', err);
                            loadSession(data.sessionId);
                        });
                }
            })
            .catch(error => {
                console.error("[错误] 发送失败:", error);
                removeSystemMessage(systemMessage);
            });
    }

    // 添加用户/系统消息
    function addMessage(content, type) {
        const history = document.getElementById('chat-history');

        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${type}-message`;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = content;

        msgDiv.appendChild(contentDiv);
        history.appendChild(msgDiv);

        // 如果是系统消息，存储引用
        if (type === 'system') {
            state.systemMessages.push(msgDiv);
        }

        scrollToBottom();
        return msgDiv;
    }

    // 添加系统消息
    function addSystemMessage(content) {
        return addMessage(content, 'system');
    }

    // 移除特定系统消息
    function removeSystemMessage(element) {
        const index = state.systemMessages.indexOf(element);
        if (index !== -1) {
            element.remove();
            state.systemMessages.splice(index, 1);
        }
    }

    // 移除所有系统消息
    function removeSystemMessages() {
        console.log("[系统] 移除所有系统消息");
        state.systemMessages.forEach(msg => msg.remove());
        state.systemMessages = [];
    }

    // 清除占位符
    function clearNoSessionPlaceholder() {
        const sessionList = document.getElementById('session-list');
        const emptyMessage = sessionList.querySelector('.empty-message');
        if (emptyMessage) {
            // 直接移除整个会话项容器
            emptyMessage.parentNode.remove();
        }
    }

    // 处理SSE消息片段
    function processChunk(chunk) {
        if (!state.currentBotMessage) {
            // 创建新的AI消息
            state.currentBotMessage = createBotMessage(chunk);
        } else {
            // 追加到现有消息
            const contentDiv = state.currentBotMessage.querySelector('.message-content');
            contentDiv.textContent += chunk;
        }
        scrollToBottom();
    }

    // 创建AI消息
    function createBotMessage(initialContent) {
        const history = document.getElementById('chat-history');
        const msgDiv = document.createElement('div');
        msgDiv.className = 'message bot-message';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = initialContent;

        msgDiv.appendChild(contentDiv);
        history.appendChild(msgDiv);
        scrollToBottom();

        return msgDiv;
    }

    // 滚动到底部
    function scrollToBottom() {
        const history = document.getElementById('chat-history');
        history.scrollTop = history.scrollHeight;
    }
</script>
</body>
</html>