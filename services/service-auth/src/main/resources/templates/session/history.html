<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>问答历史</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* 修复后的标题栏样式 */
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-left h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .back-icon {
            margin-right: 5px;
            font-size: 16px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .filter-section {
            background-color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .history-container {
            flex: 1;
            padding: 0 20px 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .history-table-container {
            flex: 1;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            overflow: hidden;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        .filter-group label {
            font-size: 14px;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .filter-input {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .filter-input:focus {
            border-color: #3498db;
        }

        .action-button {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
            align-self: flex-end;
            margin-top: auto;
        }

        .action-button:hover {
            background-color: #2980b9;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
        }

        .history-table th {
            background-color: #f9f9f9;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            user-select: none;
        }

        .history-table th:hover {
            background-color: #f0f0f0;
        }

        .history-table th::after {
            content: '';
            display: inline-block;
            width: 0;
            height: 0;
            margin-left: 5px;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            opacity: 0.3;
        }

        .history-table th.asc::after {
            content: '↑';
            opacity: 1;
        }

        .history-table th.desc::after {
            content: '↓';
            opacity: 1;
        }

        .history-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            word-wrap: break-word;
        }

        .history-table tr:hover {
            background-color: #f5f5f5;
        }

        .history-table tr td:first-child {
            font-weight: 500;
        }

        .pagination {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            align-items: center;
        }

        .pagination button {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            margin: 0 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .pagination button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 14px;
            margin-right: 15px;
        }

        .action-notification {
            background-color: #3498db;
            color: white;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
<!-- 顶部标题栏 -->
<div class="header">
    <div class="header-content">
        <div class="header-left">
            <h1>问答历史</h1>
            <button id="back-button" class="back-button" onclick="navigateToDashboard()">
                <span class="back-icon">←</span> 返回控制台
            </button>
        </div>

        <div class="header-right">
            <span>您好，<span id="userNameDisplay" th:text="${userName}">用户</span></span>
            <a href="/auth/logout?clientId=" style="color: white; margin-left: 15px;"
               onclick="handleLogout()">登出</a>
        </div>
    </div>
</div>

<!-- 筛选区域 -->
<div class="filter-section">
    <div class="filters">
        <div class="filter-group">
            <label for="sessionIdFilter">会话ID</label>
            <input type="text" id="sessionIdFilter" class="filter-input" placeholder="输入会话ID">
        </div>

        <div class="filter-group">
            <label for="startTime">开始时间</label>
            <input type="text" id="startTime" class="filter-input time-input" placeholder="选择开始时间">
        </div>

        <div class="filter-group">
            <label for="endTime">结束时间</label>
            <input type="text" id="endTime" class="filter-input time-input" placeholder="选择结束时间">
        </div>

        <button class="action-button" id="search-btn">搜索</button>
    </div>
</div>

<!-- 历史记录显示区域 -->
<div class="history-container">
    <div class="history-table-container">
        <div class="section-title">问答历史记录</div>

        <div id="notification" class="action-notification">加载中...</div>

        <div id="table-content" style="height: calc(100% - 100px); overflow-y: auto;">
            <table class="history-table">
                <thead>
                <tr>
                    <th width="20%" data-sort="session_id">会话ID</th>
                    <th width="20%" data-sort="question">问题</th>
                    <th width="30%" data-sort="answer">回答</th>
                    <th width="15%" data-sort="ask_time">提问时间</th>
                    <th width="15%" data-sort="answer_time">回答时间</th>
                </tr>
                </thead>
                <tbody id="history-table-body">
                <tr>
                    <td colspan="5" style="text-align: center;">加载历史记录中...</td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="pagination">
            <span class="pagination-info">显示 <span id="start-record">0</span> 到 <span id="end-record">0</span> 条，共 <span id="total-records">0</span> 条记录</span>
            <button id="prev-btn" disabled>上一页</button>
            <button id="next-btn" disabled>下一页</button>
            <input type="hidden" id="userId" th:value="${userId}">
            <input type="hidden" id="userName" th:value="${userName}">
            <input type="hidden" id="AUTH_TOKEN" th:value="${AUTH_TOKEN}">
        </div>
    </div>
</div>

<script>
    function navigateToDashboard() {
        const userId = document.getElementById('userId').value;
        const userName = document.getElementById('userName').value;
        const authToken = document.getElementById('AUTH_TOKEN').value;
        window.location.href = `/view/dashboard?userId=${userId}&userName=${userName}&token=${authToken}`;
    }

    document.addEventListener('DOMContentLoaded', function() {
        // 初始化时间选择器
        initDatePickers();

        // 初始化页面
        fetchHistory();

        // 设置事件监听
        setupEventListeners();
    });

    // 全局状态
    const state = {
        currentPage: 1,
        pageSize: 10,
        totalItems: 0,
        sortColumn: null,
        sortDirection: 'desc',
        historyData: [],
        filteredData: []
    };

    // 初始化日期选择器
    function initDatePickers() {
        flatpickr('.time-input', {
            enableTime: true,
            dateFormat: 'Y-m-d H:i',
            time_24hr: true
        });
    }

    // 设置事件监听
    function setupEventListeners() {
        // 搜索按钮
        document.getElementById('search-btn').addEventListener('click', function() {
            state.currentPage = 1;
            fetchHistory();
        });

        // 分页按钮
        document.getElementById('prev-btn').addEventListener('click', function() {
            if (state.currentPage > 1) {
                state.currentPage--;
                renderHistoryTable();
            }
        });

        document.getElementById('next-btn').addEventListener('click', function() {
            if (state.currentPage < Math.ceil(state.totalItems / state.pageSize)) {
                state.currentPage++;
                renderHistoryTable();
            }
        });

        // 表头排序
        document.querySelectorAll('.history-table th[data-sort]').forEach(th => {
            th.addEventListener('click', function() {
                const column = this.dataset.sort;

                // 切换排序方向
                if (state.sortColumn === column) {
                    state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    state.sortColumn = column;
                    state.sortDirection = 'desc';
                }

                // 更新UI
                document.querySelectorAll('.history-table th').forEach(header => {
                    header.classList.remove('asc', 'desc');
                });
                this.classList.add(state.sortDirection);

                // 应用排序并重新渲染
                applySorting();
                renderHistoryTable();
            });
        });
    }

    // 获取历史数据
    function fetchHistory() {
        const notification = document.getElementById('notification');
        notification.textContent = '正在加载历史数据...';
        notification.style.display = 'block';

        // 获取筛选参数
        const sessionId = document.getElementById('sessionIdFilter').value;
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;

        const userId = document.getElementById('userId').value;
        const authToken = document.getElementById('AUTH_TOKEN').value;

        // 发送请求到后端
        fetch('/history/all', {
            method: 'GET',
            headers: {
                'X-User-Id': userId,
                'X-Auth-Token': authToken
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('获取历史记录失败');
                }
                return response.json();
            })
            .then(data => {
                // 保存数据
                state.historyData = data;
                state.totalItems = data.length;

                // 应用筛选
                applyFilters(sessionId, startTime, endTime);

                // 应用排序
                applySorting();

                // 渲染表格
                renderHistoryTable();

                // 隐藏通知
                notification.style.display = 'none';
            })
            .catch(error => {
                console.error('获取历史记录错误:', error);
                notification.textContent = `获取历史记录失败: ${error.message}`;
                notification.style.backgroundColor = '#e74c3c';
            });
    }

    // 应用筛选条件
    function applyFilters(sessionId, startTime, endTime) {
        // 复制原始数据
        state.filteredData = [...state.historyData];

        // 会话ID筛选
        if (sessionId) {
            state.filteredData = state.filteredData.filter(item =>
                item.sessionId.toLowerCase().includes(sessionId.toLowerCase())
            );
        }

        // 开始时间筛选
        if (startTime) {
            state.filteredData = state.filteredData.filter(item =>
                new Date(item.askTime) >= new Date(startTime)
            );
        }

        // 结束时间筛选
        if (endTime) {
            state.filteredData = state.filteredData.filter(item =>
                new Date(item.answerTime) <= new Date(endTime)
            );
        }

        // 更新总数
        state.totalItems = state.filteredData.length;
    }

    // 应用排序
    function applySorting() {
        if (!state.sortColumn) return;

        state.filteredData.sort((a, b) => {
            let valueA = a[state.sortColumn];
            let valueB = b[state.sortColumn];

            // 处理日期排序
            if (state.sortColumn.includes('time')) {
                valueA = new Date(valueA);
                valueB = new Date(valueB);
            }

            // 处理字符串排序
            if (typeof valueA === 'string') {
                return state.sortDirection === 'asc' ?
                    valueA.localeCompare(valueB) :
                    valueB.localeCompare(valueA);
            }

            // 处理数字和日期排序
            return state.sortDirection === 'asc' ?
                valueA - valueB :
                valueB - valueA;
        });
    }

    // 渲染历史表格
    function renderHistoryTable() {
        const tableBody = document.getElementById('history-table-body');

        // 计算当前页数据
        const startIndex = (state.currentPage - 1) * state.pageSize;
        const endIndex = Math.min(startIndex + state.pageSize, state.filteredData.length);
        const currentPageData = state.filteredData.slice(startIndex, endIndex);

        // 更新分页信息
        document.getElementById('start-record').textContent = state.totalItems === 0 ? 0 : startIndex + 1;
        document.getElementById('end-record').textContent = state.totalItems === 0 ? 0 : endIndex;
        document.getElementById('total-records').textContent = state.totalItems;

        // 更新分页按钮状态
        document.getElementById('prev-btn').disabled = state.currentPage === 1;
        document.getElementById('next-btn').disabled = endIndex >= state.totalItems;

        // 渲染表格内容
        if (currentPageData.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">未找到匹配的历史记录</td></tr>`;
            return;
        }

        let html = '';
        currentPageData.forEach(item => {
            html += `
                <tr>
                    <td>${item.sessionId}</td>
                    <td>${item.question}</td>
                    <td>${item.answer}</td>
                    <td>${formatDateTime(item.askTime)}</td>
                    <td>${formatDateTime(item.answerTime)}</td>
                </tr>
            `;
        });

        tableBody.innerHTML = html;
    }

    // 格式化日期时间
    function formatDateTime(dateTime) {
        if (!dateTime) return '';

        const date = new Date(dateTime);
        return date.toLocaleString();
    }

    // 导航函数
    function navigateToKnowledge() {
        const userId = state.userId;
        const authToken = state.authToken;
        window.location.href = `/view/knowledge?userId=${userId}&token=${authToken}`;
    }

    function navigateToHistory() {
        const userId = state.userId;
        const authToken = state.authToken;
        window.location.href = `/view/history?userId=${userId}&token=${authToken}`;
    }

    // 获取用户凭证
    function getUserCredentials() {
        // 在实际应用中，这些值应该从Thymeleaf模型或认证cookie中获取
        return {
            userId: "12345",
            authToken: "abcd1234efgh5678"
        };
    }
</script>
</body>
</html>